<!DOCTYPE html><html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>لوحة تحكم السائق - ALLO BILAL</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;800&family=Cairo:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
body { font-family:'Cairo', sans-serif; background:linear-gradient(135deg,#0f172a 0%,#203a43 50%,#2c5364 100%); color:#f8fafc; min-height:100vh; overflow-x:hidden; line-height:1.5; margin:0; }
.header { display:flex; justify-content:space-between; align-items:center; padding:15px 20px; background:#111827; box-shadow:0 2px 8px rgba(0,0,0,0.3); }
.logo { font-family:'Orbitron', sans-serif; font-size:22px; font-weight:800; color:#38bdf8; }
.user-info { display:flex; align-items:center; gap:15px; }
.user-avatar { width:40px; height:40px; border-radius:50%; background:#38bdf8; display:flex; align-items:center; justify-content:center; font-weight:700; color:#111827; }
.nav-btn { background:#ef4444; color:#fff; border:none; padding:6px 12px; border-radius:5px; cursor:pointer; }
.main-container { padding:20px; }
.section-title { font-size:20px; font-weight:700; display:flex; align-items:center; gap:10px; margin-bottom:15px; }
.realtime-indicator { display:flex; align-items:center; gap:8px; margin-bottom:10px; }
.realtime-dot { width:10px; height:10px; border-radius:50%; background:#22c55e; animation:blink 1s infinite; }
@keyframes blink { 0%,50%,100%{opacity:1;} 25%,75%{opacity:0;} }
.debug-info { font-size:14px; background:rgba(255,255,255,0.05); padding:10px; border-radius:6px; margin-bottom:15px; }
.debug-info.success { border-left:4px solid #22c55e; }
.debug-info.error { border-left:4px solid #ef4444; }
.debug-info.warning { border-left:4px solid #facc15; }
.debug-info.info { border-left:4px solid #3b82f6; }
.refresh-btn { background:#3b82f6; color:#fff; border:none; padding:8px 14px; border-radius:5px; cursor:pointer; margin-bottom:20px; }
.order-card { background:rgba(255,255,255,0.05); padding:12px 15px; border-radius:6px; margin-bottom:12px; display:flex; justify-content:space-between; align-items:center; }
.order-card.pending { border-left:4px solid #22c55e; }
.order-info { display:flex; flex-direction:column; gap:3px; }
.order-actions button { margin-left:5px; padding:4px 10px; border:none; border-radius:5px; cursor:pointer; color:#fff; }
.order-actions .accept { background:#22c55e; }
.order-actions .reject { background:#ef4444; }
.empty-state { text-align:center; font-size:16px; opacity:0.8; margin-top:20px; }
.notification { position:fixed; top:20px; right:20px; background:rgba(0,0,0,0.8); color:#fff; padding:10px 15px; border-radius:6px; display:flex; align-items:center; gap:8px; opacity:0; pointer-events:none; transition:opacity 0.4s; }
.notification.show { opacity:1; pointer-events:auto; }
.notification.success { background:#22c55e; }
.notification.error { background:#ef4444; }
.notification.info { background:#3b82f6; }
.notification.warning { background:#facc15; color:#111827; }
</style>
</head>
<body>
<header class="header">
  <div class="logo">ALLO BILAL</div>
  <div class="user-info">
    <div class="user-avatar" id="userAvatar">س</div>
    <div>
      <div id="userName">السائق</div>
      <div style="font-size: 13px; opacity: 0.8; margin-top: 2px;" id="vehicleTypeInfo">جارٍ التحميل...</div>
    </div>
    <button class="nav-btn" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> خروج</button>
  </div>
</header><div class="main-container">
  <h2 class="section-title"><i class="fas fa-tachometer-alt"></i> لوحة التحكم</h2>
  <div class="realtime-indicator"><span class="realtime-dot"></span><span id="realtimeStatus">التحديث التلقائي مفعل</span></div>
  <div class="debug-info" id="debugInfo"><i class="fas fa-info-circle"></i> جارٍ تحميل معلومات السائق...</div>
  <button class="refresh-btn" id="refreshBtn"><i class="fas fa-sync-alt"></i> تحديث الطلبات</button>
  <div id="availableOrdersContainer"><div class="empty-state">جارٍ تحميل الطلبات...</div></div>
</div><div class="notification" id="notification"><i class="fas fa-bell"></i> <span id="notificationText">جارٍ تحميل البيانات...</span></div><script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script><script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script><script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script><script>
const firebaseConfig = {
  apiKey: "AIzaSyBPnZzN7DPWRSgiYDAS_bgBqGULL3-MdSU",
  authDomain: "alobilal23.firebaseapp.com",
  projectId: "alobilal23",
  storageBucket: "alobilal23.firebasestorage.app",
  messagingSenderId: "989762991926",
  appId: "1:989762991926:web:822e72a777192f614ae597"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);

let currentUserId=null, driverVehicleType=null, driverName='', availableOrdersUnsubscribe=null;

document.addEventListener('DOMContentLoaded', ()=>{
  firebase.auth().onAuthStateChanged(async user=>{
    if(!user) return window.location.href='login.html';
    currentUserId=user.uid;
    await loadDriverData();
    setupRealtimeListeners();
    showNotification('مرحباً! التحديث التلقائي مفعل','success');
  });

  document.getElementById('refreshBtn').addEventListener('click', ()=>{
    showNotification('جارٍ التحديث...','info');
    if(availableOrdersUnsubscribe) availableOrdersUnsubscribe();
    setTimeout(()=>{setupRealtimeListeners(); showNotification('تم التحديث بنجاح!','success');},500);
  });

  document.getElementById('logoutBtn').addEventListener('click', logout);
});

async function loadDriverData(){
  try{
    const db=firebase.firestore();
    const driverDoc=await db.collection('users').doc(currentUserId).get();
    if(!driverDoc.exists){ showNotification('لم يتم العثور على بيانات السائق','error'); return; }
    const driverData=driverDoc.data();
    driverVehicleType=driverData.vehicleType||'motorcycle';
    driverName=driverData.name||'السائق';
    document.getElementById('userName').textContent=driverName;
    document.getElementById('userAvatar').textContent=driverName.charAt(0);
    document.getElementById('vehicleTypeInfo').textContent=`مركبتك: ${getVehicleTypeLabel(driverVehicleType)}`;
    updateDebugInfo('تم تحميل معلومات السائق بنجاح','success',{vehicleType:driverVehicleType});
  }catch(error){
    console.error(error);
    updateDebugInfo(`خطأ: ${error.message}`,'error');
    showNotification('حدث خطأ في تحميل البيانات','error');
  }
}

function setupRealtimeListeners(){
  if(!driverVehicleType){ updateDebugInfo('خطأ: نوع المركبة غير معروف','error'); return; }
  const db=firebase.firestore();
  if(availableOrdersUnsubscribe) availableOrdersUnsubscribe();

  availableOrdersUnsubscribe=db.collection('orders')
    .where('status','==','pending')
    .where('vehicleType','==',driverVehicleType)
    .onSnapshot(snapshot=>{
      const orders=[];
      snapshot.forEach(doc=>orders.push({id:doc.id, ...doc.data()}));
      orders.sort((a,b)=>(a.createdAt?.toDate?.()||new Date(0))-(b.createdAt?.toDate?.()||new Date(0)));
      renderAvailableOrders(orders);
      updateDebugInfo(`تم العثور على ${orders.length} طلب`,'success');
    },error=>{console.error(error); showNotification('حدث خطأ في تحميل الطلبات','error');});
}

function renderAvailableOrders(orders){
  const container=document.getElementById('availableOrdersContainer');
  if(orders.length===0){ container.innerHTML=`<div class="empty-state">لا توجد طلبات لـ ${getVehicleTypeLabel(driverVehicleType)}</div>`; return; }
  let html='';
  orders.forEach(order=>{
    html+=`<div class="order-card pending">
      <div class="order-info">
        <strong>العميل:</strong> ${order.customerName||'---'}<br>
        <strong>العنوان:</strong> ${order.address||'---'}<br>
        <strong>السعر:</strong> ${order.price||'---'} درهم<br>
        <strong>المسافة:</strong> ${order.distance||'---'} كم<br>
        <strong>نوع المركبة:</strong> ${getVehicleTypeLabel(order.vehicleType||'غير معروف')}
      </div>
      <div class="order-actions">
        <button class="accept" onclick="updateOrderStatus('${order.id}','accepted')">قبول</button>
        <button class="reject" onclick="updateOrderStatus('${order.id}','rejected')">رفض</button>
      </div>
    </div>`;
  });
  container.innerHTML=html;
}

function updateOrderStatus(orderId,status){
  firebase.firestore().collection('orders').doc(orderId).update({status})
    .then(()=> showNotification(`تم ${status==='accepted'?'قبول':'رفض'} الطلب بنجاح`,'success'))
    .catch(err=>{console.error(err); showNotification('حدث خطأ أثناء تحديث الطلب','error');});
}

function getVehicleTypeLabel(type){ const labels={'motorcycle':'دراجة نارية','car':'سيارة','truck':'شاحنة','غير معروف':'غير معروف'}; return labels[type]||type; }
function showNotification(message,type='info'){ const notification=document.getElementById('notification'); const notificationText=document.getElementById('notificationText'); notificationText.textContent=message; notification.className='notification'; if(type==='success') notification.classList.add('success'); else if(type==='error') notification.classList.add('error'); else if(type==='info') notification.classList.add('info'); else if(type==='warning') notification.classList.add('warning'); notification.classList.add('show'); setTimeout(()=>{notification.classList.remove('show');},4500);}
function updateDebugInfo(message,type='info',details=null){ const debugInfo=document.getElementById('debugInfo'); const icons={'success':'fa-check-circle','error':'fa-exclamation-triangle','warning':'fa-exclamation-circle','info':'fa-info-circle'}; debugInfo.className=`debug-info ${type}`; debugInfo.innerHTML=`<i class="fas ${icons[type]||icons.info}"></i> <span>${message}</span>`; if(details){ const dText=Object.entries(details).map(([k,v])=>`${k}: ${v}`).join(' | '); debugInfo.innerHTML+=`<div style="font-size:12px;opacity:0.9;margin-top:8px;">${dText}</div>`;} }
function logout(){ firebase.auth().signOut().then(()=>{ showNotification('تم تسجيل الخروج بنجاح','success'); setTimeout(()=>window.location.href='index.html',1000); }).catch(error=>{ console.error(error); showNotification('حدث خطأ في تسجيل الخروج','error'); }); }
</script></body>
</html>