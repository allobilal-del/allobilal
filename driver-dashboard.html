<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#0f172a">
  <title>لوحة تحكم السائق - ALLO BILAL</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;800&family=Cairo:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --primary: #4facfe;
      --secondary: #00f2fe;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --dark: #0f172a;
      --light: #f8fafc;
    }
    body {
      font-family: 'Cairo', sans-serif;
      background: linear-gradient(135deg, var(--dark) 0%, #203a43 50%, #2c5364 100%);
      color: var(--light);
      min-height: 100vh;
      overflow-x: hidden;
      line-height: 1.5;
    }
    .header {
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(12px);
      padding: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 1000;
      border-bottom: 1px solid rgba(255, 255, 255, 0.15);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
    }
    .logo {
      font-family: 'Orbitron', sans-serif;
      font-size: 24px;
      font-weight: 800;
      background: linear-gradient(90deg, #ff512f, #dd2476, #24c6dc, #4facfe, #ffd700);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-size: 300% 300%;
      animation: gradientBG 8s ease infinite;    }
    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #ffd700, #ff512f);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 16px;
      flex-shrink: 0;
    }
    .nav-btn {
      background: rgba(255, 255, 255, 0.12);
      border: none;
      color: white;
      padding: 8px 14px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 15px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
      min-width: 80px;
      height: 36px;
    }
    .nav-btn:active {
      transform: scale(0.98);
      background: rgba(255, 255, 255, 0.2);
    }
    .main-container {
      padding: 16px;
      padding-bottom: calc(env(safe-area-inset-bottom) + 20px);
      max-width: 100%;
      width: 100%;
    }
    .dashboard-section {      background: rgba(30, 41, 59, 0.85);
      backdrop-filter: blur(12px);
      border-radius: 20px;
      padding: 24px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.35);
      border: 1px solid rgba(255, 255, 255, 0.1);
      width: 100%;
      margin-bottom: 20px;
    }
    .section-title {
      font-size: 24px;
      font-weight: 800;
      margin-bottom: 20px;
      background: linear-gradient(90deg, #ffd700, #ff512f);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      display: flex;
      align-items: center;
      gap: 10px;
      padding-bottom: 8px;
      border-bottom: 2px solid rgba(255, 215, 0, 0.2);
    }
    .realtime-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(16, 185, 129, 0.18);
      color: var(--success);
      padding: 8px 14px;
      border-radius: 50px;
      font-weight: 600;
      font-size: 14px;
      width: fit-content;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.25);
      border: 1px solid rgba(16, 185, 129, 0.3);
    }
    .realtime-dot {
      width: 8px;
      height: 8px;
      background: var(--success);
      border-radius: 50%;
      display: inline-block;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.6; transform: scale(0.9); }
      100% { opacity: 1; transform: scale(1); }
    }    .debug-info {
      background: rgba(255, 215, 0, 0.15);
      border-left: 4px solid #ffd700;
      padding: 12px;
      border-radius: 0 12px 12px 0;
      margin: 15px 0;
      font-size: 13px;
      color: #ffd700;
      display: flex;
      align-items: center;
      gap: 8px;
      line-height: 1.5;
    }
    .debug-info i {
      font-size: 18px;
    }
    .refresh-btn {
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      color: var(--dark);
      border: none;
      padding: 10px 20px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 15px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 15px 0;
      width: 100%;
      box-shadow: 0 4px 15px rgba(79, 172, 254, 0.4);
      transition: all 0.2s;
    }
    .refresh-btn:active {
      transform: scale(0.98);
      box-shadow: 0 2px 10px rgba(79, 172, 254, 0.5);
    }
    .refresh-btn i {
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: rgba(255, 255, 255, 0.65);
    }
    .empty-state i {      font-size: 56px;
      margin-bottom: 15px;
      opacity: 0.35;
    }
    .empty-state p {
      font-size: 17px;
      margin-top: 12px;
      line-height: 1.5;
    }
    .empty-state .help-text {
      background: rgba(79, 172, 254, 0.15);
      border-radius: 12px;
      padding: 15px;
      margin-top: 20px;
      font-size: 14px;
      line-height: 1.6;
      text-align: left;
    }
    .notification {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(-150%);
      background: rgba(40, 40, 60, 0.98);
      color: white;
      padding: 14px 24px;
      border-radius: 50px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
      z-index: 10000;
      font-size: 16px;
      font-weight: 600;
      transition: transform 0.35s ease;
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.15);
      display: flex;
      align-items: center;
      gap: 10px;
      max-width: 90%;
      text-align: center;
      line-height: 1.4;
    }
    .notification.show {
      transform: translateX(-50%) translateY(0);
    }
    .notification.success { background: rgba(34, 197, 94, 0.98); border-color: rgba(34, 197, 94, 0.45); }
    .notification.error { background: rgba(239, 68, 68, 0.98); border-color: rgba(239, 68, 68, 0.45); }
    .notification.info { background: rgba(59, 130, 246, 0.98); border-color: rgba(59, 130, 246, 0.45); }
    .notification.warning { background: rgba(245, 158, 11, 0.98); border-color: rgba(245, 158, 11, 0.45); }
    .order-card {
      background: rgba(255, 255, 255, 0.07);      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      border-left: 4px solid var(--primary);
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
    }
    .order-card:active {
      transform: translateX(3px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
    }
    .order-card.pending { border-left-color: var(--warning); }
    .order-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 12px;
      flex-wrap: wrap;
      gap: 8px;
    }
    .order-id {
      font-weight: 700;
      font-size: 17px;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .order-time {
      font-size: 13px;
      color: rgba(255, 255, 255, 0.75);
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .order-locations {
      margin-bottom: 16px;
      padding: 16px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 12px;
    }
    .location-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      margin-bottom: 10px;
      line-height: 1.4;
    }
    .location-item:last-child {      margin-bottom: 0;
    }
    .location-icon {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--primary);
      flex-shrink: 0;
      margin-top: 2px;
    }
    .location-icon.delivery {
      background: var(--success);
    }
    .location-label {
      font-weight: 600;
      color: rgba(255, 255, 255, 0.9);
      font-size: 14px;
      margin-bottom: 2px;
    }
    .location-address {
      color: rgba(255, 255, 255, 0.8);
      font-size: 14px;
      line-height: 1.4;
    }
    .order-details {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 16px;
      padding-top: 12px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    .detail-item {
      text-align: center;
    }
    .detail-label {
      font-size: 13px;
      color: rgba(255, 255, 255, 0.75);
      margin-bottom: 4px;
      line-height: 1.3;
    }
    .detail-value {
      font-weight: 700;
      font-size: 16px;
      color: white;
      line-height: 1.3;
    }    .order-actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 16px;
      width: 100%;
    }
    .action-btn {
      width: 100%;
      padding: 14px;
      border-radius: 12px;
      border: none;
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-family: 'Cairo', sans-serif;
      height: 48px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }
    .action-btn:active {
      transform: scale(0.985);
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.25);
    }
    .action-btn.accept {
      background: linear-gradient(90deg, rgba(16, 185, 129, 0.25), rgba(16, 185, 129, 0.15));
      color: var(--success);
      border: 1px solid rgba(16, 185, 129, 0.3);
    }
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 40px;
    }
    .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top: 3px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @media (max-width: 480px) {
      .header { padding: 12px; }
      .logo { font-size: 22px; }      .user-avatar { width: 36px; height: 36px; font-size: 15px; }
      .nav-btn { padding: 6px 12px; font-size: 14px; min-width: 70px; height: 34px; }
      .main-container { padding: 12px; }
      .dashboard-section { padding: 20px; border-radius: 16px; }
      .section-title { font-size: 22px; margin-bottom: 16px; }
      .order-card { padding: 16px; border-radius: 12px; }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="logo">ALLO BILAL</div>
    <div class="user-info">
      <div class="user-avatar" id="userAvatar">س</div>
      <div>
        <div id="userName">السائق</div>
        <div style="font-size: 13px; opacity: 0.8; margin-top: 2px;" id="vehicleTypeInfo">جارٍ التحميل...</div>
      </div>
      <button class="nav-btn" id="logoutBtn">
        <i class="fas fa-sign-out-alt"></i> خروج
      </button>
    </div>
  </header>
  
  <div class="main-container">
    <div class="dashboard-section">
      <h2 class="section-title">
        <i class="fas fa-tachometer-alt"></i> لوحة التحكم
      </h2>
      
      <div class="realtime-indicator">
        <span class="realtime-dot"></span>
        <span id="realtimeStatus">التحديث التلقائي مفعل</span>
      </div>
      
      <div class="debug-info" id="debugInfo">
        <i class="fas fa-info-circle"></i>
        <span>جارٍ تحميل معلومات السائق...</span>
      </div>
      
      <button class="refresh-btn" id="refreshBtn">
        <i class="fas fa-sync-alt"></i>
        <span>تحديث الطلبات</span>
      </button>
      
      <div id="availableOrdersContainer">
        <div class="loading">
          <div class="spinner"></div>
        </div>
      </div>    </div>
  </div>
  
  <div class="notification" id="notification">
    <i class="fas fa-bell"></i>
    <span id="notificationText">جارٍ تحميل البيانات...</span>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  
  <script>
    // تهيئة Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBPnZzN7DPWRSgiYDAS_bgBqGULL3-MdSU",
      authDomain: "alobilal23.firebaseapp.com",
      projectId: "alobilal23",
      storageBucket: "alobilal23.firebasestorage.app",
      messagingSenderId: "989762991926",
      appId: "1:989762991926:web:822e72a777192f614ae597"
    };
    
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    
    // المتغيرات العامة
    let currentUserId = null;
    let driverVehicleType = null;
    let driverName = '';
    let availableOrdersUnsubscribe = null;
    let lastOrderCheck = 0;
    let orderCount = 0;
    
    // تهيئة التطبيق عند التحميل
    document.addEventListener('DOMContentLoaded', () => {
      // التحقق من تسجيل الدخول
      firebase.auth().onAuthStateChanged(async (user) => {
        if (!user) {
          window.location.href = 'login.html';
          return;
        }
        
        currentUserId = user.uid;
        
        // تحميل معلومات السائق
        await loadDriverData();
                // إعداد التحديث التلقائي للطلبات
        setupRealtimeListeners();
        
        // عرض رسالة ترحيب
        showNotification('مرحباً! التحديث التلقائي مفعل', 'success');
      });
      
      // إعداد زر التحديث اليدوي
      document.getElementById('refreshBtn').addEventListener('click', () => {
        showNotification('جارٍ التحديث...', 'info');
        if (availableOrdersUnsubscribe) {
          availableOrdersUnsubscribe();
        }
        setTimeout(() => {
          setupRealtimeListeners();
          showNotification('تم التحديث بنجاح!', 'success');
        }, 500);
      });
      
      // إعداد زر تسجيل الخروج
      document.getElementById('logoutBtn').addEventListener('click', logout);
    });
    
    // تحميل معلومات السائق
    async function loadDriverData() {
      try {
        const db = firebase.firestore();
        const driverDoc = await db.collection('users').doc(currentUserId).get();
        
        if (driverDoc.exists) {
          const driverData = driverDoc.data();
          
          // التحقق من أن المستخدم سائق
          if (driverData.role !== 'driver') {
            showNotification('ليس لديك صلاحية الوصول إلى هذه الصفحة', 'error');
            setTimeout(() => {
              window.location.href = 'index.html';
            }, 2000);
            return;
          }
          
          // حفظ نوع مركبة السائق
          driverVehicleType = driverData.vehicleType || 'motorcycle';
          driverName = driverData.name || 'السائق';
          
          // تحديث واجهة المستخدم
          document.getElementById('userName').textContent = driverName;
          document.getElementById('userAvatar').textContent = driverName.charAt(0);
          document.getElementById('vehicleTypeInfo').textContent = `مركبتك: ${getVehicleTypeLabel(driverVehicleType)}`;
                    // تحديث معلومات التصحيح
          updateDebugInfo('تم تحميل معلومات السائق بنجاح', 'success', {
            vehicleType: driverVehicleType,
            userId: currentUserId.substring(0, 8) + '...'
          });
          
        } else {
          showNotification('لم يتم العثور على بيانات السائق', 'error');
          setTimeout(() => {
            window.location.href = 'login.html';
          }, 2000);
        }
      } catch (error) {
        console.error('خطأ في تحميل بيانات السائق:', error);
        updateDebugInfo(`خطأ: ${error.message}`, 'error');
        showNotification('حدث خطأ في تحميل البيانات', 'error');
      }
    }
    
    // إعداد الاستماع للتحديثات التلقائية - الحل الشامل
    function setupRealtimeListeners() {
      if (!driverVehicleType) {
        updateDebugInfo('خطأ: نوع المركبة غير معروف', 'error');
        showNotification('خطأ: لم يتم تحديد نوع المركبة', 'error');
        return;
      }
      
      const db = firebase.firestore();
      
      // إلغاء الاستماع القديم إذا كان موجوداً
      if (availableOrdersUnsubscribe) {
        availableOrdersUnsubscribe();
      }
      
      // محاولة 1: البحث بالفلترة الكاملة
      updateDebugInfo(`جارٍ البحث عن طلبات لـ ${getVehicleTypeLabel(driverVehicleType)}...`, 'info');
      
      availableOrdersUnsubscribe = db.collection('orders')
        .where('status', '==', 'pending')
        .where('vehicleType', '==', driverVehicleType)
        .onSnapshot({ includeMetadataChanges: true }, (snapshot) => {
          // تحديث وقت آخر فحص
          lastOrderCheck = Date.now();
          
          const orders = [];
          snapshot.forEach(doc => {
            orders.push({ id: doc.id, ...doc.data() });
          });
          
          // فرز الطلبات حسب الوقت (الأحدث أولاً)          orders.sort((a, b) => {
            const aTime = a.createdAt?.toDate?.() || a.createdAt || new Date(0);
            const bTime = b.createdAt?.toDate?.() || b.createdAt || new Date(0);
            return new Date(bTime) - new Date(aTime);
          });
          
          // تحديث العداد
          orderCount = orders.length;
          
          // تحديث معلومات التصحيح
          updateDebugInfo(
            `تم العثور على ${orderCount} طلب لـ ${getVehicleTypeLabel(driverVehicleType)}`,
            orderCount > 0 ? 'success' : 'warning',
            { orderCount, timestamp: new Date().toLocaleTimeString() }
          );
          
          renderAvailableOrders(orders);
          
        }, (error) => {
          console.error('خطأ في تحميل الطلبات (المحاولة 1):', error);
          
          // محاولة 2: البحث بدون فلترة نوع المركبة (للتصحيح)
          updateDebugInfo(`المحاولة 1 فشلت. جارٍ المحاولة بدون فلترة نوع المركبة...`, 'warning');
          
          availableOrdersUnsubscribe = db.collection('orders')
            .where('status', '==', 'pending')
            .onSnapshot((snapshot) => {
              const orders = [];
              snapshot.forEach(doc => {
                const orderData = { id: doc.id, ...doc.data() };
                // فلترة يدوية على العميل
                if (!orderData.vehicleType || orderData.vehicleType === driverVehicleType) {
                  orders.push(orderData);
                }
              });
              
              orders.sort((a, b) => {
                const aTime = a.createdAt?.toDate?.() || a.createdAt || new Date(0);
                const bTime = b.createdAt?.toDate?.() || b.createdAt || new Date(0);
                return new Date(bTime) - new Date(aTime);
              });
              
              orderCount = orders.length;
              
              updateDebugInfo(
                `الوضع التصحيحي: ${orderCount} طلب (بدون فلترة خادم)`,
                'warning',
                { fallbackMode: true, orderCount }
              );
                            renderAvailableOrders(orders, true);
              
            }, (fallbackError) => {
              console.error('خطأ في تحميل الطلبات (الوضع التصحيحي):', fallbackError);
              updateDebugInfo(`فشل تحميل الطلبات: ${fallbackError.message}`, 'error');
              showNotification('فشل تحميل الطلبات. حاول التحديث اليدوي.', 'error');
            });
        });
    }
    
    // تحديث معلومات التصحيح
    function updateDebugInfo(message, type = 'info', details = null) {
      const debugInfo = document.getElementById('debugInfo');
      const iconMap = {
        'success': 'fa-check-circle',
        'error': 'fa-exclamation-triangle',
        'warning': 'fa-exclamation-circle',
        'info': 'fa-info-circle'
      };
      
      debugInfo.className = `debug-info ${type}`;
      debugInfo.innerHTML = `
        <i class="fas ${iconMap[type] || iconMap.info}"></i>
        <span>${message}</span>
      `;
      
      // إضافة تفاصيل إضافية إذا وجدت
      if (details) {
        const detailsText = Object.entries(details)
          .map(([key, value]) => `${key}: ${value}`)
          .join(' | ');
        
        debugInfo.innerHTML += `<div style="margin-top: 8px; font-size: 12px; opacity: 0.9;">${detailsText}</div>`;
      }
    }
    
    // عرض الطلبات المتاحة
    function renderAvailableOrders(orders, isFallbackMode = false) {
      const container = document.getElementById('availableOrdersContainer');
      
      // تحديث مؤشر الوقت الحقيقي
      const statusEl = document.getElementById('realtimeStatus');
      statusEl.innerHTML = `
        <span class="realtime-dot"></span>
        ${isFallbackMode ? 
          '<span style="color: #ffd700;">الوضع التصحيحي - </span>' : ''}
        التحديث التلقائي مفعل (${orderCount} طلب)
      `;
      
      if (orders.length === 0) {        container.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-box-open"></i>
            <p>${isFallbackMode ? 'لا توجد طلبات مطابقة' : `لا توجد طلبات لـ ${getVehicleTypeLabel(driverVehicleType)}`}</p>
            <p style="font-size: 15px; margin-top: 8px; opacity: 0.8;">
              ${isFallbackMode ? 
                'تأكد من أن نوع المركبة في طلبات الزبائن مطابق' : 
                'سيتم عرض الطلبات الجديدة تلقائياً عند توفرها'}
            </p>
            <div class="help-text">
              <strong>نصائح لحل المشكلة:</strong><br>
              1. تأكد من تحديث لوحة الزبون بالإصدار الجديد<br>
              2. اطلب من الزبون اختيار نوع مركبتك عند إنشاء الطلب<br>
              3. استخدم زر "تحديث الطلبات" أعلاه<br>
              4. إذا استمرت المشكلة، اتصل بالدعم الفني
            </div>
          </div>
        `;
        return;
      }
      
      let html = `<div style="margin-bottom: 15px; padding: 12px; background: rgba(16, 185, 129, 0.1); border-radius: 12px; border-left: 3px solid var(--success);">
        <i class="fas fa-check-circle" style="margin-left: 5px;"></i>
        <strong>${orders.length}</strong> طلب جديد ${isFallbackMode ? '(وضع تصحيحي)' : `لـ ${getVehicleTypeLabel(driverVehicleType)}`}
      </div>`;
      
      orders.forEach(order => {
        // التحقق من وجود نوع المركبة في الطلب
        const orderVehicleType = order.vehicleType || 'غير معروف';
        const vehicleMatch = orderVehicleType === driverVehicleType;
        
        html += `
          <div class="order-card pending" data-id="${order.id}" style="${!vehicleMatch ? 'border-left-color: #ffd700; background: rgba(255, 215, 0, 0.1);' : ''}">
            <div class="order-header">
              <div class="order-id">
                <i class="fas fa-shopping-bag"></i> طلب #${order.id.substring(0, 5)}
                ${!vehicleMatch ? `<span style="background: rgba(255, 215, 0, 0.2); color: #ffd700; padding: 2px 6px; border-radius: 6px; font-size: 12px; margin-right: 6px;">${getVehicleTypeLabel(orderVehicleType)}</span>` : ''}
              </div>
              <div class="order-time">
                <i class="fas fa-clock"></i> ${order.createdAt ? formatTimeAgo(order.createdAt) : 'الآن'}
              </div>
            </div>
            
            <div class="order-locations">
              <div class="location-item">
                <div class="location-icon">
                  <i class="fas fa-map-marker-alt"></i>
                </div>
                <div>
                  <div class="location-label">الاستلام</div>                  <div class="location-address">${order.pickupLocation?.substring(0, 25) || '---'}</div>
                </div>
              </div>
              <div class="location-item">
                <div class="location-icon delivery">
                  <i class="fas fa-truck"></i>
                </div>
                <div>
                  <div class="location-label">التسليم</div>
                  <div class="location-address">${order.deliveryLocation?.substring(0, 25) || '---'}</div>
                </div>
              </div>
            </div>
            
            <div class="order-details">
              <div class="detail-item">
                <div class="detail-label">الزبون</div>
                <div class="detail-value">${order.customerName?.substring(0, 12) || '---'}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">السعر</div>
                <div class="detail-value">${order.suggestedPrice ? order.suggestedPrice + ' درهم' : '---'}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">المسافة</div>
                <div class="detail-value">~${calculateDistance(order)} كم</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">الوقت</div>
                <div class="detail-value">${calculateDeliveryTime(order)} دقيقة</div>
              </div>
            </div>
            
            <div class="order-actions">
              <button class="action-btn accept" data-id="${order.id}">
                <i class="fas fa-check-circle"></i> قبول الطلب
              </button>
            </div>
            
            ${!vehicleMatch ? `
              <div style="background: rgba(255, 215, 0, 0.15); border-radius: 8px; padding: 8px; margin-top: 10px; font-size: 13px; color: #ffd700;">
                <i class="fas fa-exclamation-triangle" style="margin-left: 4px;"></i>
                ملاحظة: هذا الطلب لـ <strong>${getVehicleTypeLabel(orderVehicleType)}</strong> وليس لمركبتك (${getVehicleTypeLabel(driverVehicleType)}). 
                قد يكون هناك خطأ في إنشاء الطلب.
              </div>
            ` : ''}
          </div>
        `;
      });
            container.innerHTML = html;
      
      // إضافة مستمعات للأزرار
      document.querySelectorAll('.action-btn.accept').forEach(button => {
        button.addEventListener('click', (e) => {
          const orderId = e.currentTarget.getAttribute('data-id');
          acceptOrder(orderId);
        });
      });
      
      // إظهار إشعار عند وجود طلب جديد
      if (orders.length > 0 && orders.length > orderCount) {
        const latestOrder = orders[0];
        showNotification(`طلب جديد! #${latestOrder.id.substring(0, 5)} - ${getVehicleTypeLabel(latestOrder.vehicleType || driverVehicleType)}`, 'info');
      }
      
      // تحديث العداد
      orderCount = orders.length;
    }
    
    // قبول الطلب
    async function acceptOrder(orderId) {
      try {
        showNotification('جارٍ قبول الطلب...', 'info');
        
        const db = firebase.firestore();
        await db.collection('orders').doc(orderId).update({
          driverId: currentUserId,
          status: 'accepted',
          acceptedAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showNotification('تم قبول الطلب بنجاح! اذهب لاستلام الطلب', 'success');
        
      } catch (error) {
        console.error('خطأ في قبول الطلب:', error);
        
        // معالجة أخطاء محددة
        if (error.code === 'permission-denied' || error.message.includes('No document to update')) {
          showNotification('هذا الطلب تم قبوله من قبل سائق آخر', 'error');
        } else if (error.code === 'not-found') {
          showNotification('الطلب غير موجود', 'error');
        } else {
          showNotification('حدث خطأ في قبول الطلب. حاول مرة أخرى', 'error');
          updateDebugInfo(`خطأ في قبول الطلب: ${error.message}`, 'error');
        }
      }
    }
        // دوال مساعدة
    function getVehicleTypeLabel(type) {
      const labels = {
        'motorcycle': 'دراجة نارية',
        'car': 'سيارة',
        'truck': 'شاحنة',
        'غير معروف': 'غير معروف'
      };
      return labels[type] || type;
    }
    
    function formatTimeAgo(timestamp) {
      if (!timestamp) return '---';
      
      const now = new Date();
      const orderTime = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
      const diffMinutes = Math.floor((now - orderTime) / 60000);
      
      if (diffMinutes < 1) return 'الآن';
      if (diffMinutes < 60) return `${diffMinutes} دقيقة`;
      if (diffMinutes < 1440) return `${Math.floor(diffMinutes / 60)} ساعة`;
      return `${Math.floor(diffMinutes / 1440)} يوم`;
    }
    
    function calculateDistance(order) {
      return Math.floor(Math.random() * 14) + 2;
    }
    
    function calculateDeliveryTime(order) {
      const distance = calculateDistance(order);
      return Math.floor(distance * Math.random() * 2 + 3);
    }
    
    // عرض الإشعار
    function showNotification(message, type = 'info') {
      const notification = document.getElementById('notification');
      const notificationText = document.getElementById('notificationText');
      
      notificationText.textContent = message;
      notification.className = 'notification';
      
      if (type === 'success') notification.classList.add('success');
      else if (type === 'error') notification.classList.add('error');
      else if (type === 'info') notification.classList.add('info');
      else if (type === 'warning') notification.classList.add('warning');
      
      notification.classList.add('show');
      
      setTimeout(() => {
        notification.classList.remove('show');      }, 4500);
    }
    
    // تسجيل الخروج
    function logout() {
      firebase.auth().signOut().then(() => {
        showNotification('تم تسجيل الخروج بنجاح', 'success');
        setTimeout(() => {
          window.location.href = 'index.html';
        }, 1000);
      }).catch((error) => {
        console.error('خطأ في تسجيل الخروج:', error);
        showNotification('حدث خطأ في تسجيل الخروج', 'error');
      });
    }
    
    // إشعار ترحيبي عند التحميل
    window.addEventListener('load', () => {
      setTimeout(() => {
        const loadingEl = document.querySelector('.loading');
        if (loadingEl) {
          loadingEl.style.display = 'none';
        }
      }, 1500);
      
      // فحص دوري للطلبات (كل 30 ثانية)
      setInterval(() => {
        if (Date.now() - lastOrderCheck > 30000) {
          updateDebugInfo('إعادة تحميل الطلبات تلقائياً...', 'info');
          setupRealtimeListeners();
        }
      }, 30000);
    });
    
    // تنظيف الاستماع عند مغادرة الصفحة
    window.addEventListener('beforeunload', () => {
      if (availableOrdersUnsubscribe) availableOrdersUnsubscribe();
    });
  </script>
</body>
</html>